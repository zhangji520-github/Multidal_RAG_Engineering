# Multi-Modal RAG Engineering

åŸºäº LangGraph çš„å¤šæ¨¡æ€æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰ç³»ç»Ÿï¼Œé›†æˆæ··åˆæ£€ç´¢ã€ä¸Šä¸‹æ–‡è®°å¿†å’Œæ™ºèƒ½è·¯ç”±åŠŸèƒ½ã€‚

## é¡¹ç›®ç‰¹æ€§

- ğŸ” **æ··åˆæ£€ç´¢**ï¼šç»“åˆå¯†é›†å‘é‡ï¼ˆDenseï¼‰å’Œç¨€ç–å‘é‡ï¼ˆSparse BM25ï¼‰æ£€ç´¢
- ğŸ¯ **æ™ºèƒ½è·¯ç”±**ï¼šæ ¹æ®æŸ¥è¯¢ç±»å‹è‡ªåŠ¨é€‰æ‹©æœ€ä½³å¤„ç†è·¯å¾„
- ğŸ’¾ **ä¸Šä¸‹æ–‡è®°å¿†**ï¼šæ”¯æŒå¤šç”¨æˆ·å†å²å¯¹è¯æ£€ç´¢å’Œç®¡ç†
- ğŸ–¼ï¸ **å¤šæ¨¡æ€æ”¯æŒ**ï¼šå¤„ç†æ–‡æœ¬å’Œå›¾ç‰‡çš„å‘é‡åŒ–æ£€ç´¢
- ğŸ”„ **äººæœºååŒ**ï¼šå…³é”®å†³ç­–èŠ‚ç‚¹æ”¯æŒäººå·¥å®¡æ ¸
- ğŸŒ **å®æ—¶æœç´¢**ï¼šé›†æˆç½‘ç»œæœç´¢å·¥å…·è·å–æœ€æ–°ä¿¡æ¯
- ğŸ“Š **å½’ä¸€åŒ–é‡æ’åº**ï¼šä½¿ç”¨ WeightedRanker è§£å†³ä¸åŒåº¦é‡æ ‡å‡†çš„åˆ†æ•°å½’ä¸€åŒ–é—®é¢˜

## ç³»ç»Ÿæ¶æ„

![å·¥ä½œæµç¨‹å›¾](static/graph_rag.png)

### å·¥ä½œæµç¨‹è¯´æ˜

1. **è¾“å…¥å¤„ç†ï¼ˆprocess_inputï¼‰**
   - æ¥æ”¶ç”¨æˆ·è¾“å…¥å¹¶è¿›è¡Œé¢„å¤„ç†
   - æå–å…³é”®ä¿¡æ¯å’Œä¸Šä¸‹æ–‡

2. **æ™ºèƒ½æ‘˜è¦ï¼ˆsummarize_if_neededï¼‰**
   - å¯¹é•¿æ–‡æœ¬è¿›è¡Œè‡ªåŠ¨æ‘˜è¦
   - ä¼˜åŒ–åç»­æ£€ç´¢æ•ˆç‡

3. **è·¯ç”±å†³ç­–ï¼ˆfirst_agent_decisionï¼‰**
   - åˆ†ææŸ¥è¯¢æ„å›¾
   - æ™ºèƒ½è·¯ç”±è‡³ä»¥ä¸‹è·¯å¾„ä¹‹ä¸€ï¼š
     - ğŸ“š çŸ¥è¯†åº“æ£€ç´¢ï¼ˆretrieve_databaseï¼‰
     - ğŸ’¬ å†å²å¯¹è¯æ£€ç´¢ï¼ˆsearch_contextï¼‰
     - ğŸŒ å®æ—¶ç½‘ç»œæœç´¢ï¼ˆweb_search_nodeï¼‰
     - âŒ ç›´æ¥ç»“æŸï¼ˆæ— éœ€æ£€ç´¢ï¼‰

4. **çŸ¥è¯†åº“æ£€ç´¢ï¼ˆretrieve_databaseï¼‰**
   - ä½¿ç”¨æ··åˆæ£€ç´¢ç­–ç•¥ï¼ˆDense + Sparseï¼‰
   - WeightedRanker å½’ä¸€åŒ–é‡æ’åº
   - æ”¯æŒæ–‡æœ¬å’Œå›¾ç‰‡å¤šæ¨¡æ€æŸ¥è¯¢

5. **ä¸Šä¸‹æ–‡æ£€ç´¢ï¼ˆsearch_contextï¼‰**
   - æ£€ç´¢ç”¨æˆ·å†å²å¯¹è¯è®°å½•
   - æ”¯æŒå¤šç”¨æˆ·éš”ç¦»
   - å¯é€‰æ‹©ç»§ç»­çŸ¥è¯†åº“æ£€ç´¢æˆ–ç›´æ¥ç”Ÿæˆç­”æ¡ˆ

6. **æ™ºèƒ½ç”Ÿæˆ**
   - **second_agent_generate**ï¼šåŸºäºå†å²ä¸Šä¸‹æ–‡ç”Ÿæˆç­”æ¡ˆ
   - **third_chatbot**ï¼šåŸºäºçŸ¥è¯†åº“å†…å®¹ç”Ÿæˆç­”æ¡ˆ
   - **fourth_chatbot**ï¼šåŸºäºç½‘ç»œæœç´¢ç»“æœç”Ÿæˆç­”æ¡ˆ

7. **ç­”æ¡ˆè¯„ä¼°ï¼ˆevaluate_nodeï¼‰**
   - è‡ªåŠ¨è¯„ä¼°ç”Ÿæˆç­”æ¡ˆçš„è´¨é‡
   - å†³å®šæ˜¯å¦éœ€è¦äººå·¥å®¡æ ¸

8. **äººå·¥å®¡æ ¸ï¼ˆhuman_approval_nodeï¼‰**
   - å…³é”®å†³ç­–ç‚¹çš„äººå·¥ä»‹å…¥
   - æ”¯æŒå®¡æ‰¹é€šè¿‡æˆ–è§¦å‘ç½‘ç»œæœç´¢è¡¥å……

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: LangGraph, LangChain
- **å‘é‡æ•°æ®åº“**: Milvus (æ”¯æŒæ··åˆæ£€ç´¢)
- **LLM**: é€šä¹‰åƒé—® (Qwen)
- **åµŒå…¥æ¨¡å‹**: DashScope Text Embedding
- **OCR**: DoTS OCR (æ–‡æ¡£è§£æ)
- **è¯­è¨€**: Python 3.x

## é¡¹ç›®ç»“æ„

```
Multidal_RAG_Engineering/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ final_rag/
â”‚       â”œâ”€â”€ workflow.py          # ä¸»å·¥ä½œæµå®šä¹‰
â”‚       â””â”€â”€ utils/
â”‚           â”œâ”€â”€ nodes.py         # å·¥ä½œæµèŠ‚ç‚¹å®ç°
â”‚           â”œâ”€â”€ routers.py       # è·¯ç”±å†³ç­–é€»è¾‘
â”‚           â”œâ”€â”€ tools.py         # å·¥å…·å‡½æ•°ï¼ˆæ£€ç´¢ã€æœç´¢ï¼‰
â”‚           â”œâ”€â”€ state.py         # çŠ¶æ€ç®¡ç†
â”‚           â””â”€â”€ prompt.py        # æç¤ºè¯æ¨¡æ¿
â”œâ”€â”€ milvus_db/
â”‚   â”œâ”€â”€ milvus_db_with_schema.py # Milvus æ•°æ®åº“æ“ä½œ
â”‚   â”œâ”€â”€ milvus_retrieve.py       # æ··åˆæ£€ç´¢å®ç°
â”‚   â””â”€â”€ collections_operator.py  # é›†åˆç®¡ç†
â”œâ”€â”€ dots_ocr/                    # OCR æ–‡æ¡£è§£ææ¨¡å—
â”œâ”€â”€ splitters/                   # æ–‡æ¡£åˆ†å‰²å™¨
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ embeddings_utils.py      # å‘é‡åŒ–å·¥å…·
â”‚   â”œâ”€â”€ common_utils.py          # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ log_utils.py             # æ—¥å¿—å·¥å…·
â”œâ”€â”€ tests/                       # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ static/
â”‚   â””â”€â”€ graph_rag.png            # å·¥ä½œæµç¨‹å›¾
â”œâ”€â”€ env_utils.py                 # ç¯å¢ƒé…ç½®
â”œâ”€â”€ llm_utils.py                 # LLM è°ƒç”¨å°è£…
â””â”€â”€ .gitignore
```

## æ ¸å¿ƒåŠŸèƒ½

### 1. æ··åˆæ£€ç´¢ä¸å½’ä¸€åŒ–é‡æ’åº

```python
# ä½¿ç”¨ WeightedRanker + å½’ä¸€åŒ–è§£å†³ COSINE å’Œ BM25 åˆ†æ•°ä¸å¯æ¯”é—®é¢˜
ranker = Function(
    name="weighted_ranker",
    input_field_names=[],
    function_type=FunctionType.RERANK,
    params={
        "reranker": "weighted",
        "weights": [1.0, 0.5],  # dense å’Œ sparse æƒé‡
        "norm_score": True      # å¯ç”¨ arctan å½’ä¸€åŒ–
    }
)

# æ··åˆæ£€ç´¢
res = client.hybrid_search(
    collection_name=COLLECTION_NAME,
    reqs=[dense_req, sparse_req],
    ranker=ranker,
    limit=10
)

# åº”ç”¨é˜ˆå€¼è¿‡æ»¤ï¼ˆå½’ä¸€åŒ–ååˆ†æ•°èŒƒå›´ [0, ~1.57]ï¼‰
filtered_results = [item for item in res[0] if item.distance >= 0.9]
```

### 2. æ™ºèƒ½è·¯ç”±å†³ç­–

ç³»ç»Ÿæ ¹æ®æŸ¥è¯¢å†…å®¹è‡ªåŠ¨é€‰æ‹©å¤„ç†è·¯å¾„ï¼š
- ä¸“ä¸šçŸ¥è¯† â†’ çŸ¥è¯†åº“æ£€ç´¢
- ä¸ªäººé—®é¢˜ â†’ å†å²å¯¹è¯æ£€ç´¢
- å®æ—¶ä¿¡æ¯ â†’ ç½‘ç»œæœç´¢
- ç®€å•é—®å€™ â†’ ç›´æ¥å“åº”

### 3. å¤šç”¨æˆ·ä¸Šä¸‹æ–‡ç®¡ç†

```python
# æ”¯æŒç”¨æˆ·çº§åˆ«çš„å†å²å¯¹è¯éš”ç¦»
filter_expr = f"user == '{user_name}'"
res = client.hybrid_search(
    collection_name=CONTEXT_COLLECTION_NAME,
    reqs=[dense_req, sparse_req],
    ranker=ranker,
    limit=5,
    output_fields=["context_text"],
)
```

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒé…ç½®

1. å®‰è£…ä¾èµ–ï¼š
```bash
pip install -r requirements.txt
```

2. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆ`.env` æ–‡ä»¶ï¼‰ï¼š
```env
DASHSCOPE_API_KEY=your_api_key
MILVUS_URI=your_milvus_uri
COLLECTION_NAME=your_collection
CONTEXT_COLLECTION_NAME=your_context_collection
```

3. åˆå§‹åŒ– Milvus æ•°æ®åº“ï¼š
```bash
python milvus_db/milvus_db_with_schema.py
```

### è¿è¡Œç¤ºä¾‹

```bash
# è¿è¡Œä¸»å·¥ä½œæµ
python src/final_rag/workflow.py

# è¿è¡Œæµ‹è¯•
python tests/test_workflow_interactive.py
```

## é…ç½®è¯´æ˜

### æ··åˆæ£€ç´¢å‚æ•°

- **Dense æ£€ç´¢**: COSINE ç›¸ä¼¼åº¦ï¼Œé€‚åˆè¯­ä¹‰åŒ¹é…
- **Sparse æ£€ç´¢**: BM25 ç®—æ³•ï¼Œé€‚åˆå…³é”®è¯åŒ¹é…
- **æƒé‡æ¯”ä¾‹**: dense=1.0, sparse=0.5ï¼ˆå¯è°ƒæ•´ï¼‰
- **å½’ä¸€åŒ–é˜ˆå€¼**: 0.9ï¼ˆå½’ä¸€åŒ–åï¼ŒèŒƒå›´ [0, 1.57]ï¼‰

### Ranker é€‰æ‹©

æ”¯æŒä¸¤ç§é‡æ’åºç­–ç•¥ï¼ˆå¯åœ¨ `tools.py` ä¸­åˆ‡æ¢ï¼‰ï¼š

**æ–¹æ¡ˆ1: RRF Ranker**ï¼ˆè‡ªåŠ¨å½’ä¸€åŒ–ï¼‰
```python
ranker = RRFRanker(k=60)
```

**æ–¹æ¡ˆ2: Weighted Ranker**ï¼ˆå½“å‰ä½¿ç”¨ï¼Œæ‰‹åŠ¨å½’ä¸€åŒ–ï¼‰
```python
ranker = Function(..., params={"norm_score": True})
```

## æ€§èƒ½ä¼˜åŒ–

1. **å‘é‡ç»´åº¦**: 1536 (DashScope)
2. **æ£€ç´¢æ•°é‡**: åˆå§‹ 10 æ¡ï¼Œé˜ˆå€¼è¿‡æ»¤åé€šå¸¸ 3-5 æ¡
3. **å½’ä¸€åŒ–æ–¹æ³•**: arctan å‡½æ•°ï¼Œè§£å†³ä¸åŒåº¦é‡æ ‡å‡†çš„åˆ†æ•°å½’ä¸€åŒ–
4. **ç¼“å­˜ç­–ç•¥**: æ”¯æŒå†å²å¯¹è¯ç¼“å­˜ï¼Œå‡å°‘é‡å¤æ£€ç´¢

## å¼€å‘è®¡åˆ’

- [ ] æ”¯æŒæ›´å¤š LLM æ¨¡å‹
- [ ] æ·»åŠ æµå¼è¾“å‡ºåŠŸèƒ½
- [ ] ä¼˜åŒ–å¤šè½®å¯¹è¯ç®¡ç†
- [ ] å¢å¼ºå›¾ç‰‡ç†è§£èƒ½åŠ›
- [ ] æ”¯æŒæ›´å¤šå‘é‡æ•°æ®åº“

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## è®¸å¯è¯

MIT License

## è”ç³»æ–¹å¼

- ä½œè€…: zhangji520-github
- é‚®ç®±: 2944405449@shu.edu.cn

---

â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ª Starï¼

